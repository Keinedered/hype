# Исправления структуры БД для соблюдения иерархии КУРС → МОДУЛИ → УРОКИ

## Проблемы, которые были исправлены:

### 1. Модель Lesson
**Было:**
- `module_id` был `nullable=True` - уроки могли существовать без модуля
- `ondelete="SET NULL"` - при удалении модуля уроки оставались без модуля

**Стало:**
- `module_id` теперь `nullable=False` - уроки обязаны быть привязаны к модулю
- `ondelete="CASCADE"` - при удалении модуля уроки удаляются вместе с ним

### 2. Схемы (schemas.py)
**Было:**
- `LessonBase.module_id: Optional[str] = None` - опциональное поле
- `LessonCreate.module_id: Optional[str] = None` - можно было создать урок без модуля

**Стало:**
- `LessonBase.module_id: str` - обязательное поле
- `LessonCreate.module_id: str` - обязательно при создании урока

### 3. Роутеры (admin_courses.py)
**Исправления:**
- При создании урока проверяется наличие `module_id`
- При удалении модуля удаляются все его уроки (вместо освобождения)
- Убрана возможность фильтрации уроков без модуля (`module_id='free'`)
- Обновлена логика обновления счетчиков

### 4. Утилиты (utils.py)
**Исправления:**
- `update_course_lesson_count` теперь не проверяет `module_id.isnot(None)`, так как все уроки обязаны иметь модуль

### 5. Миграция БД
**Создан файл:** `backend/fix_lesson_module_constraint.py`
- Удаляет уроки без модуля (если такие есть)
- Изменяет `module_id` на `NOT NULL`
- Изменяет внешний ключ на `CASCADE`

## Структура БД теперь строго соблюдает иерархию:

```
КУРС (Course)
  └── МОДУЛЬ (Module) - обязательная связь через course_id
       └── УРОК (Lesson) - обязательная связь через module_id
```

## Синхронизация:

1. **Счетчики:**
   - `course.module_count` - автоматически обновляется при создании/удалении модулей
   - `course.lesson_count` - автоматически обновляется при создании/удалении уроков

2. **Граф знаний:**
   - При создании курса создается узел графа
   - При создании модуля создается узел графа и связь с курсом
   - При создании урока создается узел графа и связь с модулем
   - При удалении каскадно удаляются узлы графа

3. **Каскадные удаления:**
   - Удаление курса → удаление модулей → удаление уроков
   - Удаление модуля → удаление уроков
   - Все связи в графе знаний удаляются автоматически

## Запуск миграции:

Миграция запускается автоматически при старте сервера (в `main.py`).

Для ручного запуска:
```bash
cd backend
python fix_lesson_module_constraint.py
```

## Проверка:

После применения миграции убедитесь, что:
1. Все уроки имеют `module_id`
2. Невозможно создать урок без модуля
3. При удалении модуля удаляются все его уроки
4. Счетчики `module_count` и `lesson_count` корректны

